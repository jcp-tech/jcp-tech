name: Deploy to Test Server (Health Main Prod)

on:
    push:
        branches:
            - main
        paths-ignore:
            - "**/*.ipynb"

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            # - name: Get Runner IP
            #   run: |
            #       echo "Runner IP:"
            #       curl http://ifconfig.me/

            - name: Deploy to MAIN Production Server
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.JCV_SERVER_HOST }}
                  username: ${{ secrets.JCV_SERVER_USERNAME || 'root' }}
                  password: ${{ secrets.JCV_SERVER_PASSWORD }}
                  port: ${{ secrets.JCV_SERVER_PORT || '22' }}
                  timeout: 60s
                  command_timeout: 30m
                  script: |
                      set -e

                      PROJECT_ROOT="/home/Django-Unchained/jcp-tech"

                      echo "Checking if project directory exists..."
                      if [ ! -d "$PROJECT_ROOT" ]; then
                          echo "Error: Directory $PROJECT_ROOT does not exist"
                          exit 1
                      fi

                      cd "$PROJECT_ROOT" || exit 1
                      echo "Successfully changed to $PROJECT_ROOT"

                      echo "Pulling latest code from main..."
                      git pull origin main

                      echo "Building Docker containers..."
                      docker compose build

                      echo "Starting services..."
                      docker compose up -d

                      echo "Production deployment successful."
